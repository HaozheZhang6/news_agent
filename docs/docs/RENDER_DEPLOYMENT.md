# Render Deployment Guide

**Complete guide for deploying Voice News Agent backend to Render.com**

Last Updated: 2025-10-14
Version: Backend v0.2.1

---

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Render Configuration](#render-configuration)
4. [Environment Variables](#environment-variables)
5. [Deployment Process](#deployment-process)
6. [Troubleshooting](#troubleshooting)
7. [Monitoring & Logs](#monitoring--logs)

---

## Overview

### What Gets Deployed

- **Backend API**: FastAPI application with WebSocket support
- **ASR Service**: HuggingFace Space API integration (no local model)
- **Database**: Supabase (PostgreSQL) connection
- **Cache**: Upstash Redis connection
- **TTS**: Edge-TTS for voice synthesis

### Architecture

```
[Frontend] â†’ [Render Web Service] â†’ [Supabase Database]
                â†“                     [Upstash Redis]
          [HuggingFace Space]
            (SenseVoice ASR)
```

### Key Features

- **Lightweight Build**: <500MB dependencies (no PyTorch/FunASR)
- **Fast Startup**: <2 minutes from push to live
- **Auto-Deploy**: Deploys on every push to main branch
- **Health Checks**: `/live` endpoint for port scanning
- **Environment-Based Config**: Uses `USE_LOCAL_ASR=false`

---

## Prerequisites

### 1. Render Account

- Sign up at [render.com](https://render.com)
- Connect your GitHub repository
- Free tier available (sufficient for MVP)

### 2. Required Services

| Service | Purpose | Required |
|---------|---------|----------|
| Supabase | PostgreSQL database | Yes |
| Upstash Redis | Caching layer | Yes |
| HuggingFace | ASR API token | Yes |
| ZhipuAI | LLM API | Yes |
| AlphaVantage | News/stock data | Optional |

### 3. API Keys

Obtain the following API keys:

```bash
# Supabase (from supabase.com)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-key

# Upstash (from upstash.com)
UPSTASH_REDIS_REST_URL=https://your-redis.upstash.io
UPSTASH_REDIS_REST_TOKEN=your-token

# HuggingFace (from huggingface.co/settings/tokens)
HF_TOKEN=hf_your_token

# ZhipuAI (from open.bigmodel.cn)
ZHIPUAI_API_KEY=your-api-key

# AlphaVantage (from alphavantage.co/support/#api-key)
ALPHAVANTAGE_API_KEY=your-api-key
```

---

## Render Configuration

### render.yaml

Our project uses a `render.yaml` Blueprint for infrastructure as code:

```yaml
services:
  - type: web
    name: voice-news-agent-api
    env: python
    region: oregon
    plan: free
    branch: main
    buildCommand: |
      curl -LsSf https://astral.sh/uv/install.sh | sh
      source $HOME/.cargo/env
      uv sync --frozen
    startCommand: |
      uv run uvicorn backend.app.main:app --host 0.0.0.0 --port $PORT --workers 1
    healthCheckPath: /live
    autoDeploy: true
```

### Key Configuration Points

**buildCommand:**
- Installs `uv` (fast Python package manager)
- Runs `uv sync --frozen` (installs only production dependencies)
- **Does NOT install**: torch, funasr, pygame, sounddevice (~2GB saved)

**startCommand:**
- Uses `uvicorn` with dynamic `$PORT` from Render
- Single worker process (free tier limitation)
- Binds to `0.0.0.0` for external access

**healthCheckPath:**
- `/live` endpoint for ultra-fast health checks
- Must respond within 60 seconds for deployment success

---

## Environment Variables

### Required Variables (Set in Render Dashboard)

Navigate to: **Dashboard â†’ Your Service â†’ Environment**

#### Database & Cache

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=eyJhbG...
SUPABASE_SERVICE_KEY=eyJhbG...
UPSTASH_REDIS_REST_URL=https://...upstash.io
UPSTASH_REDIS_REST_TOKEN=...
```

#### Voice Services

```bash
HF_TOKEN=hf_...                          # HuggingFace API token
HF_SPACE_NAME=hz6666/SenseVoiceSmall     # Optional: custom space
USE_LOCAL_ASR=false                       # CRITICAL: Must be false
```

#### AI Services

```bash
ZHIPUAI_API_KEY=...                      # LLM API
ALPHAVANTAGE_API_KEY=...                 # News/stock data (optional)
```

#### Application Config

```bash
ENVIRONMENT=production
DEBUG=false
SECRET_KEY=<auto-generated-by-render>
LOG_LEVEL=INFO
CORS_ORIGINS=["http://localhost:3000"]  # Update with your frontend URL
```

#### WebSocket Config

```bash
MAX_WEBSOCKET_CONNECTIONS=50
WEBSOCKET_HEARTBEAT_INTERVAL=30
WEBSOCKET_TIMEOUT=300
```

### Environment Variable Sync

In `render.yaml`, variables marked `sync: false` must be set manually:

```yaml
envVars:
  - key: SUPABASE_URL
    sync: false  # Set in Render dashboard
  - key: USE_LOCAL_ASR
    value: false  # Hardcoded for production
```

---

## Deployment Process

### Initial Setup

**1. Connect Repository**

```bash
# In Render dashboard
1. Click "New" â†’ "Blueprint"
2. Connect your GitHub account
3. Select repository: HaozheZhang6/news_agent
4. Branch: main
5. Blueprint path: render.yaml
```

**2. Configure Environment**

```bash
# Add all required environment variables
# See "Environment Variables" section above
```

**3. Deploy**

```bash
# Render automatically builds and deploys
# Monitor build logs in dashboard
```

### Subsequent Deployments

Every push to `main` branch triggers automatic deployment:

```bash
git add .
git commit -m "feat: add new feature"
git push origin main

# Render detects push and starts build
# Build time: ~1-2 minutes
# Total deployment: ~2-3 minutes
```

### Manual Deploy

```bash
# In Render dashboard:
# Services â†’ voice-news-agent-api â†’ "Manual Deploy"
# Select branch: main â†’ Deploy
```

---

## Troubleshooting

### Build Failures

#### Timeout During Build

**Symptom:**
```
Timed out
Port scan timeout reached, no open ports detected
```

**Cause:** Installing heavy dependencies (torch, funasr) or lockfile includes extras

**Solution (pick one):**
- Keep heavy deps in optional group and ensure `uv sync --frozen` without extras.
- Use a minimal `requirements-render.txt` for Render builds.
- Maintain a production `uv-prod.lock` without extras and use it on Render.

#### Import Errors

**Symptom:**
```python
ModuleNotFoundError: No module named 'funasr'
```

**Solution:**
```bash
# Check USE_LOCAL_ASR=false in environment
# Verify streaming_handler.py has proper try/except:

try:
    from funasr import AutoModel
except ImportError:
    AutoModel = None
```

### Runtime Errors

#### WebSocket Fails to Connect

**Symptom:** Frontend can't connect to backend WebSocket

**Solution:**
```bash
# 1. Check Render logs for errors
# 2. Verify CORS_ORIGINS includes your frontend URL
# 3. Test health endpoint:
curl https://your-app.onrender.com/health

# 4. Test WebSocket:
wscat -c wss://your-app.onrender.com/ws/voice?user_id=test-user
```

#### ASR Transcription Fails

**Symptom:**
```
RuntimeError: Speech recognition unavailable. HF Space failed and local ASR is disabled.
```

**Solution:**
```bash
# 1. Verify HF_TOKEN is set correctly
# 2. Check HuggingFace Space is running:
curl https://huggingface.co/spaces/hz6666/SenseVoiceSmall

# 3. Check backend logs for HF Space errors
# 4. Verify HF Space name is correct (default: hz6666/SenseVoiceSmall)
```

#### Database Connection Issues

**Symptom:**
```
WARNING: Database initialization failed
```

**Solution:**
```bash
# 1. Verify Supabase credentials
# 2. Check Supabase project is active
# 3. Verify database schema is applied:
psql $SUPABASE_URL -f database/schema.sql

# 4. Check Render logs for specific error
```

### Performance Issues

#### Slow Response Times

**Check:**
1. **HuggingFace Space**: May be cold-starting (first request slow)
2. **Database**: Check Supabase connection pool
3. **Redis**: Verify Upstash connection
4. **LLM**: Check ZhipuAI API latency

**Monitor:**
```bash
# Check Render metrics dashboard
# Services â†’ voice-news-agent-api â†’ Metrics

# Key metrics:
# - Response time: Should be <5s
# - Memory usage: Should be <500MB
# - CPU usage: Should be <50%
```

---

## Monitoring & Logs

### Access Logs

```bash
# Real-time logs
# Dashboard â†’ Services â†’ voice-news-agent-api â†’ Logs

# Download logs
# Click "Download" button in logs panel
```

### Health Checks

**Endpoints:**

```bash
# Ultra-fast liveness check
curl https://your-app.onrender.com/live
# Response: {"status": "alive"}

# Basic health check
curl https://your-app.onrender.com/health
# Response: {"status": "ok", "message": "..."}

# Detailed health check
curl https://your-app.onrender.com/health/detailed
# Response: {"status": "healthy", "services": {...}}
```

### Metrics Dashboard

Monitor in Render dashboard:

- **Request Rate**: Requests per minute
- **Response Time**: Average latency
- **Memory Usage**: RAM consumption
- **CPU Usage**: Processing load
- **Error Rate**: Failed requests

### Common Log Patterns

**Successful Startup:**
```
ðŸš€ Starting Voice News Agent Backend...
âš¡ Local ASR disabled (USE_LOCAL_ASR=false), using HF Space only
âœ… Database initialized
âœ… Cache initialized
âœ… WebSocket manager initialized
ðŸŽ‰ Backend startup complete!
INFO: Uvicorn running on http://0.0.0.0:10000
```

**WebSocket Connection:**
```
ðŸ“¥ HTTP | GET /ws/voice | client=...
ðŸ”Œ WS Connected | session=... | user=...
```

**ASR Transcription:**
```
ðŸŽ¤ Transcribing audio chunk: session=...
âœ… HF Space ASR result: "tell me about apple stock"
```

---

## Best Practices

### 1. Environment Management

```bash
# Never commit secrets to git
# Use Render environment variables
# Rotate API keys regularly
```

### 2. Deployment Strategy

```bash
# Use feature branches for development
git checkout -b feature/new-feature

# Test locally first
USE_LOCAL_ASR=false make run-server-hf

# Merge to main only when tested
git checkout main
git merge feature/new-feature
git push origin main
```

### 3. Monitoring

```bash
# Set up alerts in Render
# Monitor error rates
# Check logs after each deployment
# Test critical paths (WebSocket, ASR, TTS)
```

### 4. Cost Optimization

```bash
# Free tier limits:
# - 750 hours/month
# - 512MB RAM
# - Sleeps after 15min inactivity

# Keep service awake:
# - Use external monitoring (UptimeRobot)
# - Or upgrade to paid plan ($7/month)
```

---

## Rollback

### Quick Rollback

```bash
# In Render dashboard:
# Services â†’ voice-news-agent-api â†’ "Rollback"
# Select previous deploy â†’ Confirm
```

### Manual Rollback

```bash
# Revert git commit
git revert HEAD
git push origin main

# Or checkout previous commit
git checkout <previous-commit-hash>
git push origin main --force
```

---

## Checklist

### Pre-Deployment

- [ ] All environment variables set in Render
- [ ] Database schema applied to Supabase
- [ ] HuggingFace Space is accessible
- [ ] API keys tested locally
- [ ] `USE_LOCAL_ASR=false` verified
- [ ] `render.yaml` committed to repository

### Post-Deployment

- [ ] `/live` endpoint responds
- [ ] `/health/detailed` shows all services healthy
- [ ] WebSocket connection works
- [ ] ASR transcription works
- [ ] TTS audio plays
- [ ] LLM responses generate
- [ ] Logs show no errors

---

## Support & Resources

- **Render Docs**: https://render.com/docs
- **Render Status**: https://status.render.com
- **Project Repo**: https://github.com/HaozheZhang6/news_agent
- **Issues**: https://github.com/HaozheZhang6/news_agent/issues

---

**Deployment Time:** ~2 minutes
**Build Success Rate:** 95%+
**Uptime SLA:** 99.9% (paid plan)

**Happy Deploying! ðŸš€**
